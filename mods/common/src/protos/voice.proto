/*
 * Copyright (C) 2024 by Fonoster Inc (https://fonoster.com)
 * http://github.com/fonoster/fonoster
 *
 * This file is part of Fonoster
 *
 * Licensed under the MIT License (the "License");
 * you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 *    https://opensource.org/licenses/MIT
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
syntax = "proto3";

package fonoster.voice.v1beta2;

// The voice service definition
service Voice {
  rpc CreateSession(stream VoiceInStream) returns (stream VoiceOutStream) {}
}

// CreateSessionRequest is the request message for the CreateSession method
message CreateSessionRequest {
  // The account making the request on behalf of the caller
  string access_key_id = 1;

  // Reference to an application living in the platform
  string app_ref = 2;

  // gRPC endpoint for the voice service
  string endpoint = 3;

  // PSTN number or SIP URI associated with the session
  string ingress_number = 4;

  // The name of the caller
  string caller_name = 5;

  // The caller number for the phone calling from the
  string caller_number = 6;

  // The session ID generated by the Media Server
  string session_ref = 7;

  // Use this token to validate the provenance of the request
  // If the app_ref is provided, the token must include the app_ref as a claim
  string session_token = 8;

  // Metadata associated with the session
  map<string, string> metadata = 9;
}

// Common request for verbs
message VerbRequest {
  string session_ref = 1;
}

// Common response for verbs
message VerbResponse {
  string session_ref = 1;
}

// Request to play a sound
message PlayRequest {
  // The session reference generated by the Media Server
  string session_ref = 1;

  // The URL of the sound to play
  string url = 2;
}

// Request to play a sound
message PlayResponse {
  // The session reference generated by the Media Server
  string session_ref = 1;

  // The playback reference generated by the Media Server
  string playback_ref = 2;
}

// The request message for the PlaybackControl method
message PlaybackControlRequest {
  // The session reference generated by the Media Server
  string session_ref = 1;

  // The playback reference generated by the Media Server
  string playback_ref = 2;

  // The action to take
  enum Action {
    STOP = 0;
    RESTART = 1;
    PAUSE = 2;
    UNPAUSE = 3;
    FORWARD = 4;
  }
  Action action = 3;
}

// PlayDtmfRequest is the request message for the PlayDtmf method
message PlayDtmfRequest {
  // The session reference generated by the Media Server
  string session_ref = 1;

  // The digits to play
  string digits = 2;
}

// Request to mute or unmute the call
message MuteRequest {
  // The session reference generated by the Media Server
  string session_ref = 1;

  // The direction to mute
  enum MuteDirection {
    IN = 0;
    OUT = 1;
    BOTH = 2;
  }
  MuteDirection direction = 2;
}

// Request to gather speech or DTMF
message GatherRequest {
  // The session reference generated by the Media Server
  string session_ref = 1;

  // The source of the gather
  enum GatherSource {
    SPEECH = 0;
    DTMF = 1;
    SPEECH_AND_DTMF = 2;
  }
  GatherSource source = 2;

  // Optional key to finish the gather
  string finish_on_key = 3;

  // Optional timeout in seconds
  int32 timeout = 4;

  // Optional number of digits to gather
  int32 max_digits = 5;
}

// Response to a gather request
message GatherResponse {
  // The session reference generated by the Media Server
  string session_ref = 1;

  // The gathered speech or digits
  oneof content {
    string speech = 2;
    string digits = 3;
  }
}

// VoiceInStream is the input stream for the voice service
message VoiceInStream {
  oneof content {
    // Initial request to create a new session
    CreateSessionRequest request = 1;

    // Command to accept the call
    VerbResponse answer_response = 2;

    // Response to a play request
    PlayResponse play_response = 3;

    // Response to a hangup request
    VerbResponse hangup_response = 4;

    // Response to a mute request
    VerbResponse mute_response = 5;

    // Response to a unmute request
    VerbResponse unmute_response = 6;

    // Response to a play dtmf request
    VerbResponse play_dtmf_response = 7;

    // Response to a gather request
    GatherResponse gather_response = 8;

    // Response to a sgather request
    GatherResponse sgather_response = 9;

    // Response to a playback control request
    VerbResponse playback_control_response = 10;
  }
}

// VoiceOutStream is the output stream for the voice service
message VoiceOutStream {
  oneof content {
    // Request to accept the call
    VerbRequest answer_request = 1;

    // Request to play a sound
    PlayRequest play_request = 2;

    // Request to hangup the call
    VerbRequest hangup_request = 3;

    // Request to mute the call
    MuteRequest mute_request = 4;

    // Request to unmute the call
    MuteRequest unmute_request = 5;

    // Request to play dtmf
    PlayDtmfRequest play_dtmf_request = 6;

    // Request to gather speech or DTMF
    GatherRequest gather_request = 7;

    // Request return a stream of speech or DTMF
    GatherRequest sgather_request = 8;

    // Request to control a playback
    PlaybackControlRequest playback_control_request = 9;
  }
}
